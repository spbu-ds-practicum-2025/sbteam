# Техническое решение проекта «URL Shortener»

## Введение
  **Цель проекта:**  
  Разработка распределённой системы генерации сокращённых URL-адресов. Система позволяет быстро и безопасно сгенерировать сокращённый URL-адрес по длинному и впоследствии перейти по адресу длинной ссылки через сокращённую.

  **Задачи:**
  1. Спроектировать архитектуру приложения.
  2. Определить доменные сущности.
  3. Реализовать базовые пользовательские сценарии (генерация сокращённого адреса по длинному; переход по сокращённому адресу). 
  4. Реализовать взаимодействие сервисов.
  5. Обеспечить отказоустойчивость и высокую производительность системы.

  **Основания для разработки:**  
  Учебный проект в рамках курса «Основы распределённых вычислений».

  **Команда:**  
  | Участник | Роль |
  |----------|------|
  | Розов Владислав | Teamlead, fullstack-разработчик |
  | Романов Арсений | Backend-разработчик, архитектор |
  | Шерстобитова Елизавета | Fullstack-разработчик, DevOps |

---

## Глоссарий
| Термин        | Определение |
|---------------|-------------|
| Пользователь  | Любой клиент, отправляющий запрос |
| Длинный (исходный) URL | Оригинальный (полный) адрес, который посылает пользователь |
| Сокращённый URL | Короткая форма исходного URL, указывающая на перенаправление на исходный |
| API Gateway | Точка входа всех клиентских запросов |
| Cache (кэш) | Быстрое хранилище для ускорения ответов |
| Реплика | Копия базы данных |
| Доступность | Свойство распределённой системы предоставлять ответ на запрос пользователя даже при отказе отдельных её компонентов |
| TTL (time-to-live) | Время действия сокращённого URL |
---

## Функциональные требования
Система должна предоставлять следующие функции:
  1. Создание сокращённого URL по исходному.
  2. Переадресация по сокращённому URL.
  3. Получение метаданных по сокращённому URL.
  4. Ограничение числа запросов на пользователя.
  5. Задание TTL.
  6. Валидация URL.
  7. Гарантия уникальность сокращённого URL.

---

## Нефункциональные требования
  1. Время отклика ≤ 200мс в условиях локальной сети.
  2. Кэширование ответов на запросы чтения.
  3. Масштабируемость: разделение логических компонентов на микросервисы, репликации баз данных, распределённый кэш.
  4. Доступность > 99.9%.
  5. Отказоустойчивость: cистема продолжает раобтать при сбое одного из узлов.
  6. Согласованность: короткие URL не могут быть утеряны, гарнтируется их уникальность.
  7. Поддерживаемость и расширяемость: модульность, покрытие тестами ≥ 80%. 

---

## Пользовательские сценарии
**Сценарий: Создание короткой ссылки по длинной**

  Пользователь вводит Long URL и получает сгенерированный уникальный Short URL.

**Сценарий: Перенаправление по короткой ссылке на адрес длинной**

  Пользователь переходит по Short URL и перенарпавляется на Long URL.
  
---

##  Архитектура системы
| Компонент | Назначение |
|-----------|------------|
| API Gateway | Входная точка в систему. Отвечает за приём HTTP-запросов от write/read клиентов, маршрутизацию в соответствующие backend-сервисы по gRPC. |
| Write API | Обрабатывает запросы на создание сокращённого URL. Обращается к сервису генерации идентификаторов, валидирует входные данные и записывает результат в master-базу данных. |
| Generator | Сервис генерации коротких URL. Выдаёт уникальные короткие ключи по gRPC. Используется Write API для создания новых short URL. |
| Read API | Сервис чтения. Отвечает за получение длинного URL по сокращённому. Использует кэш для ускорения, а при промахе — обращается к реплике БД (slave). |
| Cache | Быстрое хранилище (short -> long URL) для ускорения чтения. Используется Read API. |
| Master DB | Основная база данных (write). Хранит актуальные данные о сопоставлениях URL. Принимает операции записи от Write API. |
| Un-Sync Slave | Реплика базы данных (read). Предназначена для выполнения операций чтения. Запросы от Read API идут сюда, снижая нагрузку на master. |
| In-Sync Replica | Синхронная реплика. Резервная реплика для обеспечения консистентности и восстановления после сбоев. Используется внутренними механизмами БД. |


<img width="1657" height="723" alt="Снимок экрана от 2025-11-24 23-35-51" src="https://github.com/user-attachments/assets/8c0f719a-55b3-4ae6-9d58-9e1a711c1707" />

---

## Технические сценарии

<img width="1280" height="369" alt="image" src="https://github.com/user-attachments/assets/2b373008-12a9-445a-aa32-08479fd020be" />

<img width="1280" height="367" alt="image" src="https://github.com/user-attachments/assets/c19f43a6-0fe3-4718-a6eb-0497373192ea" />


---

## План разработки и тестирования

### Основной проект (MVP)

**Включает:**
- Реализацию API Gateway (HTTP -> gRPC, роутинг, rate limiting, валидация)
- Реализацию Write API (создание сокращённых URL, валидация)
- Реализацию Generator (генерация уникальных short-id)
- Реализацию Read API (получение длинного URL по короткому, работа с кэшем)
- Интеграцию с master DB (записи) и slave DB (чтение)
- Интеграцию с кэшем (ускорение операций чтения)
- Автоматизация деплоя, масштабирование
 
---

### **План разработки:**
1. Проектирование протоколов взаимодействия (HTTP API Gateway, gRPC-сервисы)
2. Реализация API Gateway (роутинг, rate limiting, валидация запросов)
3. Реализация Generator (генерация коротких токенов)
4. Реализация Write API:
   - получение длинного URL
   - запрос к Generator
   - запись short->long в master DB
5. Реализация репликации master -> slave (использование возможностей готовой БД)
6. Реализация Read API:
   - чтение из кэша
   - fallback на slave DB
   - сохранение результата в кэш
7. Настройка кэша (Redis или аналог)
8. Документирование API (REST + gRPC)

---

### **План тестирования:**
- Модульные тесты:
  - генерация коротких ссылок (Generator)
  - логика валидации длинных ссылок (Write API)
  - доменные сущности
  - тестирование репозитория
- Интеграционные тесты:
  - логика записи (Write API)
  - логика чтения и кэширования (Read API)
  - API Gateway -> Write API / Read API
  - Write API -> master DB
  - Read API -> cache -> slave DB
  - Репликация master -> slave
- Нагрузочные тесты (только базовые):
  - массовые чтения (read-heavy)
  - массовые записи (write-heavy)

---

### **Definition of Done (DoD) для MVP:**
- Реализованы сценарии:
  - создание короткого URL
  - получение оригинального URL
- Все основные сервисы интегрированы и покрыты тестами
- Система соответствует базовым нефункциональным требованиям:
  - доступность 99.9%
  - время отклика ≤ 200мс
  - корректная работа master/slave схемы
  - кэш снижает нагрузку на БД

---

### Расширенный проект (Advanced Scope)

**Включает:**
- Аналитику (подсчёт обращений, хранение метрик, работа с отдельной analytics DB)
- Добавление очереди сообщений (Kafka) для передачи событий чтения и записи
- Масштабирование всех сервисов
- Расширенная отказоустойчивость (реплики сервисов, health-check, retries)

---

### **План разработки:**
1. Реализация Analytics Service (подписка на Kafka, запись событий в analytics DB)
2. Добавление аналитических API (количество переходов, горячие ссылки)
3. Добавление health-check, retry-политик
4. Расширенная логирование + метрики (Prometheus/Grafana)

---

### **План тестирования:**
- Интеграционные тесты Kafka:
  - публикация событий
  - обработка событий Analytics Service
- Тесты на корректность агрегированных метрик
- Тесты отказоустойчивости:
  - падение Read API / Write API
  - отставание реплики slave
  - недоступность кэша
- Нагрузочные тесты:
  - чтение 10k RPS
  - запись 2k RPS
  - стресс-тест Kafka и analytics DB

---

### **Definition of Done (DoD) для расширенного проекта:**
- Реализованы:
  - сбор аналитики переходов
  - хранение и отображение статистики
  - масштабирование всех сервисов
- Доступность ≥ 99.99%
- Время отклика ≤ 100 мс
- Система выдерживает нагрузку согласно нефункциональным требованиям
- Все функциональные и аналитические компоненты покрыты тестами

---
